import React from 'react';
import { Space, Table, Button, Modal, Form, Input, message, Pagination, PaginationProps   } from 'antd';
import { EyeOutlined, EyeTwoTone, EyeInvisibleOutlined } from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import {useQuery,useMutation,useQueryClient} from '@tanstack/react-query';
import { axiosClient } from '../../library/axiosClient';
import { useNavigate, useSearchParams } from 'react-router-dom';
import config from '../../constants/config';
import moment from 'moment';

interface DataType {
  _id?: string;
  firstName: string;
  lastName: string;
  email: string;
  phoneNumber: string;
  address?: string;
  birthDay?: Date;
  password: string;
  photo?: string;
  role: string;
  position?: string;
  department?: string;
  isActive?: boolean;
 
}

const Employees= () => {

  const [messageApi, contextHolder] = message.useMessage();
  //Toggle Modal Edit
  const [isModalEditOpen, setIsModalEditOpen] = React.useState(false);
  //Toggle Modal Create
  const [isModalCreateOpen, setIsModalCreateOpen] = React.useState(false);
  // ·∫®n m·∫≠t kh·∫©u
  const [showPassword, setShowPassword] = React.useState(false);
  //Modal x√°c nh·∫≠n x√≥a.
  const [isDeleteModalOpen, setIsDeleteModalOpen] = React.useState(false);
  const [itemToDelete, setItemToDelete] = React.useState<string | DataType | undefined>(undefined);

  
  const navigate = useNavigate();
  //=========================== PH√ÇN TRANG =================================//
  const [params] = useSearchParams();
  const page = params.get('page');
  const limit = params.get('limit');
  const int_page = page ? parseInt(page) : 1;
  const int_limit = limit ? parseInt(limit) :5;
  const onChangePagination: PaginationProps['onChange'] = (pageNumber) => {
    console.log('Page: ', pageNumber);
    navigate(`/employee?page=${pageNumber}`);
  };

 
  //Lay danh sach danhmuc
  const getemployees = async (page = 1, limit = 5)=> {
      return axiosClient.get(config.urlAPI+`/v1/employees?page=${page}&limit=${limit}`);
  }

  // Access the client
  const queryClient = useQueryClient()

  //L·∫•y danh s√°ch v·ªÅ
  const queryemployee = useQuery({
    queryKey: ['employees', int_page],
    queryFn: ()=>getemployees(int_page, int_limit) 
  });

  console.log('<<=== üöÄ queryemployee.data ===>>',queryemployee.data?.data.data.employees);


  //======= S·ª± ki·ªán X√ìA =====//
  const fetchDelete = async (objectID: string | DataType) => {
    const idToDelete = typeof objectID === 'string' ? objectID : objectID._id;
    return axiosClient.delete(config.urlAPI+'/v1/employees/'+idToDelete);
} 

  // Mutations => Th√™m m·ªõi, x√≥a, edit
  const mutationDelete = useMutation({
    mutationFn: fetchDelete,
    onSuccess: () => {
      console.log('X√≥a th√†nh c√¥ng !');
      messageApi.open({
        type: 'success',
        content: 'X√≥a th√†nh c√¥ng !',
      });
      // L√†m t∆∞∆°i l·∫°i danh s√°ch danh m·ª•c d·ª±a tr√™n key ƒë√£ ƒë·ªãnh nghƒ©a
      queryClient.invalidateQueries({ queryKey: ['employees'] })
    },
    onError: ()=>{
      //khi g·ªçi API b·ªã l·ªói
    }
  });

  //======= S·ª± ki·ªán EDit =====//
  const fetchUpdate = async (formData: DataType) => {
    const {_id, ...payload} = formData;
    return axiosClient.patch(config.urlAPI+'/v1/employees/'+_id, payload);
  } 
  // Mutations => Th√™m m·ªõi, x√≥a, edit
  const mutationUpdate = useMutation({
    mutationFn: fetchUpdate,
    onSuccess: () => {
      console.log('C·∫≠p nh·∫≠t th√†nh c√¥ng !');
      messageApi.open({
        type: 'success',
        content: 'C·∫≠p nh·∫≠t th√†nh c√¥ng !',
      });
      // L√†m t∆∞∆°i l·∫°i danh s√°ch danh m·ª•c d·ª±a tr√™n key ƒë√£ ƒë·ªãnh nghƒ©a
      queryClient.invalidateQueries({ queryKey: ['employees'] });
      //·∫®n modal
      setIsModalEditOpen(false);
    },
    onError: ()=>{
      //khi g·ªçi API b·ªã l·ªói
    }
  });

  const [updateForm] = Form.useForm();
  //Khi nh·∫•n nut OK tr√™n Modal
  const handleEditOk = () => {
    // setIsModalEditOpen(false);
    console.log('edit submit');
    //Cho submit form trong Modal
    updateForm.submit();
  };
  //Khi nh·∫•n nut Cancel tr√™n modal
  const handleEditCancel = () => {
    setIsModalEditOpen(false);
    console.log('edit cancel');
  };

  //h√†m l·∫•y th√¥ng tin t·ª´ form Edit
  const onFinishEdit = async (values: any) => {
    console.log('Success:', values); //=> ch√≠nh l√† th√¥ng tin ·ªü form edit
    //G·ªçi API ƒë·ªÉ update employee
    mutationUpdate.mutate(values);
  };

  const onFinishEditFailed = (errorInfo: any) => {
    console.log('Failed:', errorInfo);
  };

  //======= S·ª± ki·ªán Create =====//
  const fetchCreate = async (formData: DataType) => {
    return axiosClient.post(config.urlAPI+'/v1/employees', formData);
  } 
  // Mutations => Th√™m m·ªõi, x√≥a, edit
  const mutationCreate = useMutation({
    mutationFn: fetchCreate,
    onSuccess: () => {
      console.log('Th√™m m·ªõi th√†nh c√¥ng !');
      messageApi.open({
        type: 'success',
        content: 'Th√™m m·ªõi th√†nh c√¥ng !',
      });
      // L√†m t∆∞∆°i l·∫°i danh s√°ch danh m·ª•c d·ª±a tr√™n key ƒë√£ ƒë·ªãnh nghƒ©a
      queryClient.invalidateQueries({ queryKey: ['employees'] });
      //·∫®n modal
      setIsModalCreateOpen(false);
      createForm.resetFields();//l√†m tr·ªëng c√°c input
    },
    onError: ()=>{
      //khi g·ªçi API b·ªã l·ªói
    }
  });

  const [createForm] = Form.useForm();
  //Khi nh·∫•n nut OK tr√™n Modal
  const handleCreateOk = () => {
    // setIsModalCreateOpen(false);
    console.log('Create submit');
    //Cho submit form trong Modal
    createForm.submit();
  };
  //Khi nh·∫•n nut Cancel tr√™n modal
  const handleCreateCancel = () => {
    setIsModalCreateOpen(false);
    console.log('Create cancel');
  };
// Khi nh·∫•n n√∫t "X√°c nh·∫≠n x√≥a" tr√™n modal x√≥a
  const handleDeleteConfirm = async () => {
    // Th·ª±c hi·ªán cu·ªôc g·ªçi API ƒë·ªÉ x√≥a nh√¢n vi√™n
    await mutationDelete.mutate(itemToDelete);
 // ƒê√≥ng modal x√°c nh·∫≠n x√≥a v√† ƒë·∫∑t l·∫°i gi√° tr·ªã itemToDelete
    setIsDeleteModalOpen(false);
    setItemToDelete(undefined);
  };
// Khi nh·∫•n n√∫t "H·ªßy" tr√™n modal x√≥a
  const handleDeleteCancel = () => {
     // ƒê√≥ng modal x√°c nh·∫≠n x√≥a v√† ƒë·∫∑t l·∫°i gi√° tr·ªã itemToDelete
    setIsDeleteModalOpen(false);
    setItemToDelete(undefined);
    // C√°c h√†nh ƒë·ªông kh√°c n·∫øu c·∫ßn
  };
  

  //h√†m l·∫•y th√¥ng tin t·ª´ form Create
  const onFinishCreate = async (values: any) => {
    console.log('Success:', values); //=> ch√≠nh l√† th√¥ng tin ·ªü form edit
    //G·ªçi API ƒë·ªÉ update employee
    mutationCreate.mutate(values);
  };

  const onFinishCreateFailed = (errorInfo: any) => {
    console.log('Failed:', errorInfo);
  };


  const columns: ColumnsType<DataType> = [
    
    {
      title: 'H·ªç',
      dataIndex: 'firstName',
      key: 'firstName',
      // render: (text) => <a>{text}</a>,
    },
    {
      title: 'T√™n',
      dataIndex: 'lastName',
      key: 'lastName',
    },
    {
      title: 'Email',
      dataIndex: 'email',
      key: 'email',
      render: (text) => <a>{text}</a>,
    },
    {
      title: 'ƒêi·ªán tho·∫°i',
      dataIndex: 'phoneNumber',
      key: 'phoneNumber',
    },
    {
      title: 'ƒê·ªãa ch·ªâ',
      dataIndex: 'address',
      key: 'address',
    },
    {
      title: 'NƒÉm sinh',
      dataIndex: 'birthDay',
      key: 'birthDay',
      render: (text) => {
        const formattedDate = text ? moment(text).format('DD/MM/YYYY') : '--/--/--';
        return <span>{formattedDate}</span>;
      },
    },
    // {
    //   title: 'M·∫≠t kh·∫©u',
    //   dataIndex: 'password',
    //   key: 'password',
    // },
    {
      title: 'Avatar',
      dataIndex: 'photo',
      key: 'photo',
      render: (text) => {
        // Truncate the string to 3 characters and append "..."
        const truncatedText = text.length > 3 ? text.substring(0, 3) + '...' : text;
        return <span>{truncatedText}</span>;
      },
    },
    {
      title: 'Ch·ª©c nƒÉng',
      dataIndex: 'role',
      key: 'role',
    },
    {
      title: 'Ch·ª©c v·ª•',
      dataIndex: 'position',
      key: 'position',
    },
    {
      title: 'B·ªô ph·∫≠n',
      dataIndex: 'department',
      key: 'department',
    },
    
    
    {
      title: 'Thao t√°c',
      key: 'action',
      render: (_, record) => (
      <Space size="middle">

          <Button onClick={()=>{
            console.log('Edit this item');
            setIsModalEditOpen(true); //show modal edit l√™n
            updateForm.setFieldsValue(record);
          }}>S·ª≠a</Button>

          <Button
            danger
            onClick={() => {
              console.log('Delete this item', record);
              if (record && '_id' in record) {
                setItemToDelete(record);
                setIsDeleteModalOpen(true); // M·ªü modal x√°c nh·∫≠n x√≥a
              }
            }}
          >
            X√≥a
          </Button>



        </Space>
      ),
    },
  ];

  

  

  return (
    <>
    {contextHolder}
     <Button type="primary" onClick={()=>{
       console.log('Open Model Create employee');
       //show modal them moi
       setIsModalCreateOpen(true);
     }}>Th√™m</Button>

    <Table pagination={false} columns={columns} key={'_id'} dataSource={queryemployee.data?.data.data.employees} />
    <div>
    <Pagination
            defaultCurrent={int_page}
            total={queryemployee.data?.data.data.totalRecords}
            showSizeChanger
            defaultPageSize={int_limit}
            onChange={onChangePagination}
            showTotal={(total) => `Total ${total} items`}
          />
    </div>
     {/* begin Edit Modal */}
     <Modal title="Ch·ªânh s·ª≠a th√¥ng tin" open={isModalEditOpen} onOk={handleEditOk} onCancel={handleEditCancel}>
     <Form
      form={updateForm}
      name='edit-form'
      labelCol={{ span: 8 }}
      wrapperCol={{ span: 16 }}
      initialValues={{ remember: true }}
      onFinish={onFinishEdit}
      onFinishFailed={onFinishEditFailed}
      autoComplete="off"
    >
       <Form.Item<DataType>
        label="H·ªç"
        name="firstName"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="T√™n"
        name="lastName"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="Email"
        name="email"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="ƒêi·ªán tho·∫°i"
        name="phoneNumber"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="ƒê·ªãa ch·ªâ"
        name="address"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="NƒÉm sinh"
        name="birthDay"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="M·∫≠t kh·∫©u"
        name="password"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          { min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±' },
        ]}
      >
        <Input.Password
          type={showPassword ? 'text' : 'password'}
          iconRender={(visible) => (visible ? <EyeTwoTone /> : <EyeInvisibleOutlined />)}
          // Th√™m s·ª± ki·ªán click ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa hi·ªÉn th·ªã v√† ·∫©n m·∫≠t kh·∫©u
          suffix={
            <EyeOutlined
              onClick={() => setShowPassword(!showPassword)}
              style={{ cursor: 'pointer' }}
            />
          }
        />
      </Form.Item>

      <Form.Item<DataType>
        label="Avatar"
        name="photo"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="Quy·ªÅn"
        name="role"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>
  
      <Form.Item<DataType>
        label="Ch·ª©c v·ª•"
        name="position"
        rules={[{ max: 500, message: 'T·ªëi ƒëa 500 k√≠ t·ª±' }]}
      >
        <Input />
      </Form.Item>


      <Form.Item<DataType>
        label="B·ªô ph·∫≠n"
        name="department"
        rules={[{ max: 500, message: 'T·ªëi ƒëa 500 k√≠ t·ª±' }]}
      >
        <Input />
      </Form.Item>

      <Form.Item hidden label='Id' name='_id'>
            <Input />
      </Form.Item>
     
    </Form>
   
      </Modal>
      {/* End Edit Modal */}
      {/* Modal x√°c nh·∫≠n x√≥a */}
      <Modal
      title="X√°c nh·∫≠n x√≥a"
      open={isDeleteModalOpen}
      onOk={handleDeleteConfirm}
      onCancel={handleDeleteCancel}>
      <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?</p>
    </Modal>
      {/* begin Create Modal - Th√™m m·ªõi s·∫£n ph·∫©m*/}
     <Modal title="Th√™m m·ªõi ng∆∞·ªùi d√πng" open={isModalCreateOpen} onOk={handleCreateOk} onCancel={handleCreateCancel}>
     <Form
      form={createForm}
      name='create-form'
      labelCol={{ span: 8 }}
      wrapperCol={{ span: 16 }}
      initialValues={{ remember: true }}
      onFinish={onFinishCreate}
      onFinishFailed={onFinishCreateFailed}
      autoComplete="off"
    >
      <Form.Item<DataType>
        label="H·ªç"
        name="firstName"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="T√™n"
        name="lastName"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="Email"
        name="email"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="ƒêi·ªán tho·∫°i"
        name="phoneNumber"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="ƒê·ªãa ch·ªâ"
        name="address"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="NƒÉm sinh"
        name="birthDay"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="M·∫≠t kh·∫©u"
        name="password"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          { min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±' },
        ]}
      >
        <Input.Password
          type={showPassword ? 'text' : 'password'}
          iconRender={(visible) => (visible ? <EyeTwoTone /> : <EyeInvisibleOutlined />)}
          // Th√™m s·ª± ki·ªán click ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa hi·ªÉn th·ªã v√† ·∫©n m·∫≠t kh·∫©u
          suffix={
            <EyeOutlined
              onClick={() => setShowPassword(!showPassword)}
              style={{ cursor: 'pointer' }}
            />
          }
        />
      </Form.Item>

      <Form.Item<DataType>
        label="Avatar"
        name="photo"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>

      <Form.Item<DataType>
        label="Quy·ªÅn"
        name="role"
        rules={[
          { required: true, message: 'Please input employee Name!' },
          {min: 4, message: 'T·ªëi thi·ªÉu 4 k√≠ t·ª±'}
        ]}
      >
        <Input />
      </Form.Item>
  
      <Form.Item<DataType>
        label="Ch·ª©c v·ª•"
        name="position"
        rules={[{ max: 500, message: 'T·ªëi ƒëa 500 k√≠ t·ª±' }]}
      >
        <Input />
      </Form.Item>


      <Form.Item<DataType>
        label="B·ªô ph·∫≠n"
        name="department"
        rules={[{ max: 500, message: 'T·ªëi ƒëa 500 k√≠ t·ª±' }]}
      >
        <Input />
      </Form.Item>
    </Form>
   
      </Modal>
      {/* End Create Modal */}
      

    </>
  )
};

export default Employees;